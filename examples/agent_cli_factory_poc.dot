digraph AgentCliFactoryPOC {
  graph [goal="Build a working agent CLI in agent/ with cheap-model defaults and deterministic mock mode"];

  start [shape=Mdiamond];
  exit [shape=Msquare];
  exit_config_fail [shape=Msquare];

  lint_scenarios [
    shape=parallelogram,
    type=tool,
    tool_command="bash scripts/scenarios/lint_scenarios.sh scripts/scenarios"
  ];

  preflight_live_deps [
    shape=parallelogram,
    type=tool,
    tool_command="bash scripts/scenarios/preflight_provider_live.sh"
  ];

  ensure_agent_dir [
    shape=parallelogram,
    type=tool,
    allowed_write_paths="agent/",
    tool_command="mkdir -p agent"
  ];

  implement [
    shape=box,
    agent.backend="codex",
    codex.path=".factory/bin/codex",
    codex.disable_mcp=true,
    codex.sandbox="workspace-write",
    codex.approval="never",
    codex.workdir="agent",
    codex.add_dirs="examples/specs",
    codex.strict_read_scope=true,
    codex.timeout_seconds=900,
    codex.heartbeat_seconds=15,
    codex.skip_git_repo_check=true,
    allowed_write_paths="agent/",
    prompt="Read ../examples/specs/agent_cli_builder_spec.md.\n\nImplement the CLI in this directory (agent/).\n\nRules:\n- Only modify files in this directory\n- Do not read or rely on scenario scripts\n- Do not rely on orchestrator/pipeline metadata\n- Return strict JSON and include verification_plan.\n\nRun local checks before finishing.\nUse GOCACHE=\"$PWD/.gocache\" for go commands."
  ];

  verify_plan [
    shape=parallelogram,
    type=verification,
    "verification.workdir"="agent",
    "verification.allowed_commands"="go test,go build,gofmt,bash scripts/scenarios/agent_cli_component_checks.sh,bash scripts/scenarios/agent_cli_user_scenarios.sh,bash scripts/scenarios/preflight_scenario.sh,bash scripts/scenarios/preflight_provider_live.sh"
  ];

  validate_component [
    shape=parallelogram,
    type=tool,
    tool_command="bash scripts/scenarios/agent_cli_component_checks.sh agent"
  ];

  validate_user_scenarios [
    shape=parallelogram,
    type=tool,
    tool_command="bash scripts/scenarios/preflight_scenario.sh scripts/scenarios/agent_cli_user_scenarios.sh agent"
  ];

  fix [
    shape=box,
    agent.backend="codex",
    codex.path=".factory/bin/codex",
    codex.disable_mcp=true,
    codex.sandbox="workspace-write",
    codex.approval="never",
    codex.workdir="agent",
    codex.add_dirs="examples/specs",
    codex.strict_read_scope=true,
    codex.timeout_seconds=900,
    codex.heartbeat_seconds=15,
    codex.skip_git_repo_check=true,
    allowed_write_paths="agent/",
    prompt="Validation failed.\n\nFix this directory (agent/) so validations pass.\nRead ../examples/specs/agent_cli_builder_spec.md.\nDo not read or rely on scenario scripts.\nDo not rely on orchestrator/pipeline metadata.\nReturn strict JSON and include verification_plan.\nUse GOCACHE=\"$PWD/.gocache\" for go commands."
  ];

  start -> lint_scenarios;
  lint_scenarios -> preflight_live_deps [condition="outcome=success"];
  lint_scenarios -> exit_config_fail [condition="outcome=fail"];
  preflight_live_deps -> ensure_agent_dir [condition="outcome=success"];
  preflight_live_deps -> exit_config_fail [condition="outcome=fail"];
  ensure_agent_dir -> implement [condition="outcome=success"];
  ensure_agent_dir -> exit_config_fail [condition="outcome=fail"];

  implement -> verify_plan [condition="outcome=success"];
  implement -> fix [condition="outcome=fail"];

  verify_plan -> validate_component [condition="outcome=success"];
  verify_plan -> fix [condition="outcome=fail"];

  validate_component -> validate_user_scenarios [condition="outcome=success"];
  validate_component -> fix [condition="outcome=fail"];

  validate_user_scenarios -> exit [condition="outcome=success"];
  validate_user_scenarios -> fix [condition="outcome=fail"];

  fix -> validate_component [condition="outcome=success"];
  fix -> fix [condition="outcome=fail"];
}
